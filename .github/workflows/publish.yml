name: vsceデプロイ
run-name: vsceへの公開:${{ github.ref }}
on:
  push:
    branches:
    - master
  release:
    types: [ prereleased, released]

jobs:
  downloadBinary:
    name: ttsサービスのダウンロードとunzip
    runs-on: windows-latest
    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v3
      - name: ttsサービスのファイル削除
        run: |
          Get-ChildItem "${{github.workspace}}\bin\*.*" -exclude docs |Remove-Item
      - name: ttsサービスのzipファイルをダウンロード
        run: |
          gh release download --repo simanasch/SpeechGRpcServer v0.0.1 -D "${{ github.workspace }}\bin" -p *.zip
        env:
          GH_TOKEN: ${{secrets.READ_SPEECHGRPCSERVER}}
      - name: ttsサービスをzipから解凍
        run: |
          7z x  "${{ github.workspace }}\bin\*.zip"  -o"${{ github.workspace }}\bin" -aoa
  publish:
    name: 拡張機能を公開_vsCode
    runs-on: windows-latest
    steps:
      - name: Nodeをインストール
        uses: actions/setup-node@v3
      - name: node_modulesのインストール
        run: npm install
      - name: 拡張機能を公開
        run: |
          npm run deploy
        env:
          VSCE_PAT: ${{secrets.VSCE_PAT}}
  saveArtifact:
    name: ビルド内容の保存
    runs-on: windows-latest
    steps:
      - name: 拡張機能のパッケージを作成
        run: vsce package
      - name: ビルド内容を保存
        uses: actions/upload-artifact@v3
        with:
          name: vscePackage
          path: ./*.vsix